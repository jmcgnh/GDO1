// Log the URLs we need
// Last change: 2017-06-10
server.log("Operate garage door: " + http.agenturl() + "?command=n");
server.log("commands include: pulsedoor, opendoor, closedoor, getstatus, showstatus");
server.log("currently value 'n' is ignored, but could indicate which door to operate");
server.log("agent version " + imp.getsoftwareversion())
garageDoor1State <- "closed"; // assumption
garageDoor2State <- "closed"; // assumption
local whichdoor = 1;

function requestHandler(request, response) {
  try {
    response.header("Access-Control-Allow-Origin", "*");
    server.log( "request looks like: " + http.jsonencode( request));
    server.log( "request.query looks like: " + http.jsonencode( request.query));
    
    if (!device.isconnected()) {
            server.log("pulseDoor: Imp offline");
            throw "imp offline";
            }
    if ("pulsedoor" in request.query) {
            device.send("pulseDoor", request.query.pulsedoor);
            logdata( "status1=" + "pulsed" + "&status2=" + "")
        }
    if ("closedoor" in request.query) {
            device.send("closeDoor", request.query.closedoor);
        }
    if ("opendoor" in request.query) {
            device.send("openDoor", request.query.opendoor);
        }
    if ("getstatus" in request.query) {
            device.send("getDoorState", request.query.getstatus);
        }
    if ("showstatus" in request.query) {
            response.send(200, "1: " + garageDoor1State + "  2: " + garageDoor2State);
            return;
        }
    // normal response
    response.send(200, "OK");
  } catch (ex) {
    response.send(400, "Error: " + ex);
  }
}

// register the HTTP handler
http.onrequest(requestHandler);

// Set up the logging server address we will send to
const PUBLIC_TOKEN = "WNDG9zYMEGTX8WOApKN1hvk3XJ3"; 
const LOGGING_URL_BASE = "https://gddb.jmcg.us:41880/input/";
const PRIVATE_TOKEN = "0XgYP6LdDYTLMAyYZEaltLpKg0K";

function logdata(logMessage) {    
    // Prepare the request with a JSON payload
    local body = logMessage;
    local extraHeaders = {"Phant-Private-Key" : PRIVATE_TOKEN };
    
    local request = http.post(LOGGING_URL_BASE + PUBLIC_TOKEN, extraHeaders, logMessage);

    // Send the message
    local incomingDataTable = request.sendsync();
 
    // Display the received data
    server.log("Code: " + incomingDataTable.statuscode + ". Message: " + incomingDataTable.body);
}

// Logging to Thinger.io server on jmcg-thinger
const THINGER_UID = "jmcgnh"
const THINGER_DEV_ID = "GDO1"
const THINGER_DEV_CRED = "4mtzL4eGuQ#8"
// no further Thinger code, abandoned this approach for now

function logit() {
    logdata( "status1=" + garageDoor1State + "&status2=" + garageDoor2State);
}

function saveDoor1State(state) {
    garageDoor1State <- state;
    logit();
}

function saveDoor2State(state) {
    garageDoor2State <- state;
    logit();
}

device.on("doorState", saveDoor1State);
device.on("door1State", saveDoor1State);
device.on("door2State", saveDoor2State);
