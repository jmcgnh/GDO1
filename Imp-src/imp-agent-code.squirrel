// Agent
// GDO1 simplified, minimal version 2017-03-14

// Log the URLs we can use
server.log("Operate garage door: " + http.agenturl() + "?command");
server.log("commands include: pulsedoor, getstatus, showstatus");

// this variable remembers the state of the garage door between requests
garageDoorState <- "closed"; // Assumed at start

// set up agent's main handler for outside requests
function requestHandler(request, response) {
  try {
    response.header("Access-Control-Allow-Origin", "*");

    if (!device.isconnected()) {
            server.log("Error: Imp offline");
            throw "imp offline";
            }
    // note that query could contain more than one request
    // but the door state may not change immediately after a
    // pulsedoor request because the actual garage door
    // may take 10-20 seconds to open or close or even after a
    // getstatus request because the device has to respond 
    // before a new state gets recorded - this delay will
    // have to be taken into account by the app or user
    // making the requests
    if ("pulsedoor" in request.query) {
            device.send("pulseDoor", 0);
        }
    if ("getstatus" in request.query) {
            device.send("getDoorState", 0);
        }
    if ("showstatus" in request.query) {
            response.send(200, garageDoorState);
            return;
        }
    // normal response
    response.send(200, "OK");
  } catch (ex) {
    response.send(400, "Error: " + ex);
  }
}

// register the HTTP handler
http.onrequest(requestHandler);

// set up handler for responses from device
function saveDoorState(state) {
    garageDoorState <- state;
    server.log("Door state: " + garageDoorState);
}

device.on("doorState", saveDoorState);
